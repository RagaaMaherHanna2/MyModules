<div class="spinner-wrapper" *ngIf="!product && !stopLoading">
  <p-progressSpinner></p-progressSpinner>
</div>
<ng-container *ngIf="product">
  <p-card styleClass="title-card">
    <div class="flex-between">
      <h4>
        {{ locale === "ar-AE" ? product.name_ar : product.name }}
      </h4>
      <div class="buttons-wrapper">
        <button
          pButton
          class="p-button-outlined"
          label="Edit"
          i18n-label
          (click)="edit()"
        ></button>

        <button
          *ngIf="!product.is_prepaid && !product.serials_auto_generated"
          pButton
          pRipple
          class="p-button-outlined"
          label="Upload Vouchers"
          i18n-label
          (click)="uploadSerials()"
        ></button>

        <button
          *ngIf="!product.is_prepaid && !product.serials_auto_generated"
          class="p-button-outlined"
          pButton
          pRipple
          type="button"
          label="Download Vouchers Template"
          i18n-label
          icon="pi pi-book"
          (click)="downloadSerialsTemplate()"
        ></button>

        <button
          *ngIf="
            !product.is_prepaid &&
            !product.serials_auto_generated &&
            product.enable_stock_history
          "
          class="p-button-outlined"
          pButton
          pRipple
          type="button"
          label="Stock History"
          i18n-label
          icon="pi pi-chart-line"
          (click)="openStockHistoryChart()"
        ></button>
      </div>
    </div>
  </p-card>
  <p-card header="Product Details" i18n-header>
    <div class="two-groups">
      <div class="details">
        <div class="info-pair">
          <span class="title" i18n>ID</span>
          <span class="value">{{ product.id }}</span>
        </div>
        <div class="info-pair">
          <span class="title" i18n>Product Name [EN]</span>
          <span class="value">{{ product.name }}</span>
        </div>

        <div class="info-pair">
          <span class="title" i18n>Product Name [AR]</span>
          <span class="value">{{ product.name_ar }}</span>
        </div>
        <div class="info-pair">
          <span class="title" i18n>Product Category</span>
          <span class="value">{{ product.categ_name }}</span>
        </div>
        <div class="info-pair">
          <span class="title" i18n>Cost</span>
          <span class="value"
            >{{ product.standard_price }}
            {{
              product.purchase_currency_id.symbol
                ? product.purchase_currency_id.symbol
                : userCurrency
            }}</span
          >
        </div>
        <div class="info-pair">
          <span class="title" i18n>Product Type</span>
          <span class="value"
            >{{ getProdutType(product) }} -
            <span
              *ngIf="product.serials_auto_generated"
              class="font-weight-bold"
              i18n
              >Auto generated By Skarla</span
            >
            <span
              *ngIf="!product.serials_auto_generated"
              class="font-weight-bold"
              i18n
              >Uploaded By Excel</span
            >
          </span>
        </div>

        <div class="info-pair" *ngIf="product.is_prepaid">
          <span class="title" i18n>Value</span>
          <span class="value">{{ product.value }}</span>
        </div>
        <div [ngSwitch]="codesAdditionalValues">
          <div *ngSwitchCase="'net_dragon'">
            <div
              class="info-pair"
              *ngIf="
                product.is_prepaid ||
                (!product.is_prepaid && product.serials_auto_generated)
              "
            >
              <span class="title" i18n>Expiry Date</span>
              <span class="value">{{
                product.expiry_date | date : "fullDate"
              }}</span>
            </div>

            <div *ngIf="product.product_specific_attribute === 'topup'">
              <div class="info-pair">
                <span class="title" i18n>Product Category</span>
                <span class="value" i18n>Top-Up</span>
              </div>
              <div class="info-pair">
                <span class="title" i18n>Product Parent Category</span>
                <span class="value" i18n>{{
                  product.netdragon_product_category.name
                }}</span>
              </div>
              <div class="info-pair">
                <span class="title" i18n>Product Brief</span>
                <span class="value" i18n>{{
                  product.netdragon_product_description
                }}</span>
              </div>
              <div class="info-pair">
                <span class="title" i18n>Product Amount</span>
                <span class="value" i18n>{{ product.product_amount }}</span>
              </div>
              <div class="info-pair">
                <span class="title" i18n>Product Currency</span>
                <span class="value" i18n>{{
                  product.product_currency.symbol
                }}</span>
              </div>
            </div>
          </div>
          <div *ngSwitchCase="'secret'">
            <div
              class="info-pair"
              *ngIf="
                product.is_prepaid ||
                (!product.is_prepaid && product.serials_auto_generated)
              "
            >
              <span class="title" i18n>Expiry period in days</span>
              <span class="value">
                {{ getProductExpiryPeriodValue(product.expiry_period) }}</span
              >
            </div>
          </div>
          <div *ngSwitchCase="'foodics'">
            <div
              class="info-pair"
              *ngIf="
                product.is_prepaid ||
                (!product.is_prepaid && product.serials_auto_generated)
              "
            >
              <span class="title" i18n>Expiry Date</span>
              <span class="value">{{
                product.expiry_date | date : "fullDate"
              }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Discount Amount</span>
              <span class="value">{{ product.foodics_discount_amount }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Discount Type</span>
              <span class="value">{{
                getFoodicsDiscountType(product.foodics_discount_type)
              }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Business Reference</span>
              <span class="value">{{
                product.foodics_business_reference
              }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Max Discount Amount</span>
              <span class="value">{{
                product.foodics_max_discount_amount
              }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Is percentage</span>
              <span class="value">{{ product.foodics_is_percent }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Is include modifiers</span>
              <span class="value">{{ product.foodics_include_modifiers }}</span>
            </div>
            <div class="info-pair">
              <span class="title" i18n>Is discount taxable </span>
              <span class="value">{{
                product.foodics_is_discount_taxable
              }}</span>
            </div>
          </div>
          <div *ngSwitchDefault>
            <div
              class="info-pair"
              *ngIf="
                product.is_prepaid ||
                (!product.is_prepaid && product.serials_auto_generated)
              "
            >
              <span class="title" i18n>Expiry Date</span>
              <span class="value">{{
                product.expiry_date | date : "fullDate"
              }}</span>
            </div>
          </div>
        </div>

        <div class="info-pair">
          <span class="title" i18n>Stock-Keeping Units (SKU)</span>
          <span class="value">{{ product.SKU }}</span>
        </div>
        <div class="info-pair">
          <span class="title" i18n>Available Vouchers</span>
          <span class="value" *ngIf="product.is_prepaid" i18n
            >Product doesn't have vouchers</span
          >
          <span class="value" *ngIf="!product.is_prepaid">{{
            product.product_serials_stock | number : "1.0-2"
          }}</span>
        </div>

        <div class="info-pair">
          <span class="title" i18n>How To Use [EN]</span>
          <a class="value" [href]="product.how_to_use" target="_blank">{{
            product.how_to_use
          }}</a>
        </div>
        <div class="info-pair">
          <span class="title" i18n>How To Use [AR]</span>
          <a class="value" [href]="product.how_to_use_ar" target="_blank">{{
            product.how_to_use_ar
          }}</a>
        </div>

        <div class="info-pair">
          <span class="title" i18n>Direct Redeem Link</span>
          <a
            class="value"
            [href]="product.direct_redeem_link"
            target="_blank"
            >{{ product.direct_redeem_link }}</a
          >
        </div>
        <div>
          <p-toggleButton
            *ngIf="product.use_skarla_portal"
            [(ngModel)]="product.use_skarla_portal"
            onLabel="Use Skarla Portal Service"
            onIcon="pi pi-check"
            [disabled]="true"
          ></p-toggleButton>
        </div>
      </div>
      <div class="image-container">
        <img [src]="product.image" />
      </div>
    </div>
  </p-card>
  <ng-container *ngIf="codesAdditionalValues === 'foodics'">
    <p-card
      header="Allowed Products"
      i18n-header
      styleClass="redeem-fields-card"
    >
      <table
        class="input-table"
        *ngIf="product.foodics_allowed_products.length > 0; else noProducts"
      >
        <thead>
          <tr>
            <th i18n>Product ID</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let prod of product.foodics_allowed_products">
            <tr>
              <td>
                <p>{{ prod.product_id }}</p>
              </td>
            </tr></ng-container
          >
        </tbody>
      </table>
      <ng-template #noProducts>
        <tr>
          <td colspan="8">
            <p i18n class="no-fields">There are no allowed products.</p>
          </td>
        </tr>
      </ng-template>
    </p-card>
  </ng-container>
  <ng-container *ngIf="product.use_skarla_portal">
    <p-card
      header="Product Attributes"
      i18n-header
      styleClass="redeem-fields-card"
    >
      <table
        class="input-table"
        *ngIf="product.product_attributes.length > 0; else noFields"
      >
        <thead>
          <tr>
            <th i18n>Attribute</th>
            <th i18n>Type</th>
            <th i18n>Required</th>
          </tr>
        </thead>
        <tbody>
          <ng-container
            *ngFor="let productAttribute of product.product_attributes"
          >
            <tr>
              <td>
                <p>{{ productAttribute.name }}</p>
              </td>
              <td>
                <p>{{ productAttribute.type }}</p>
              </td>
              <td>
                <p>{{ productAttribute.required }}</p>
              </td>
            </tr></ng-container
          >
        </tbody>
      </table>
      <ng-template #noFields>
        <tr>
          <td colspan="8">
            <p i18n class="no-fields">
              There are no additional fields for Redeem Page.
            </p>
          </td>
        </tr>
      </ng-template>
    </p-card>
  </ng-container>
  <ng-container>
    <p-card header="Inventory Status" i18n-header styleClass="serials-card">
      <table class="input-table">
        <thead>
          <tr>
            <th
              i18n
              class="medium-cell"
              *ngIf="!product.serials_auto_generated"
            >
              Available
            </th>
            <th i18n>Sold</th>
            <th i18n *ngIf="!product.serials_auto_generated">Hold</th>
            <th i18n>Expired</th>
            <th i18n>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td *ngIf="!product.serials_auto_generated">
              <p>
                {{
                  product.inventory_status.available_count | number : "1.0-2"
                }}
              </p>
            </td>
            <td>
              <p>
                {{ product.inventory_status.redeemed_count | number : "1.0-2" }}
              </p>
            </td>
            <td *ngIf="!product.serials_auto_generated">
              {{
                product.inventory_status.frozen_serial_count | number : "1.0-2"
              }}
            </td>
            <td>
              {{ product.inventory_status.expired_count | number : "1.0-2" }}
            </td>
            <td>
              {{
                product.inventory_status.available_count +
                  product.inventory_status.redeemed_count +
                  product.inventory_status.expired_count +
                  product.inventory_status.frozen_serial_count
                  | number : "1.0-2"
              }}
            </td>
          </tr>
        </tbody>
      </table>
    </p-card>
  </ng-container>

  <ng-container
    *ngIf="
      !product.is_prepaid &&
      !product.serials_auto_generated &&
      this.productBatches
    "
  >
    <p-card header="Vouchers Batches" i18n-header styleClass="batches-card">
      <p-table
        #batchesTable
        [value]="productBatches.data"
        [lazy]="true"
        [loading]="loading"
        (onLazyLoad)="loadInfo(product.id, $event)"
        [rows]="batchesPageSize"
        [paginator]="true"
        responsiveLayout="scroll"
        [totalRecords]="productBatches.totalCount"
        dataKey="id"
        [paginator]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        i18n-currentPageReportTemplate
        [showCurrentPageReport]="true"
        [rowHover]="true"
      >
        <ng-template pTemplate="header">
          <tr>
            <th i18n>Batch Sequence</th>
            <th i18n>Created Date</th>
            <th i18n>Status</th>
            <th i18n>Quantity</th>
            <th i18n>Available</th>
            <th i18n>Sold</th>
            <th i18n>Batch File</th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8">
              <span class="empty-message" i18n
                >There is no records to show
              </span>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr [id]="item.id">
            <td>{{ item.batch_sequence }}</td>
            <td>{{ item.create_date | date : "longDate" }}</td>

            <td *ngIf="item.state === '1'; else frozen" i18n>Enabled</td>
            <ng-template #frozen>
              <td i18n>Hold</td>
            </ng-template>
            <td>{{ item.batch_count }}</td>
            <td>{{ item.available_count }}</td>
            <td>{{ item.redeemed_count }}</td>
            <td>
              <a pButton class="p-button-outlined" (click)="sendViaEmail(item)">
                <span i18n>Send Via Email</span>
              </a>
            </td>
            <td>
              <button
                pButton
                *ngIf="item.state === '2'; else freezeBatchButton"
                class="p-button-outlined"
                (click)="enableBatch(item)"
              >
                <span i18n>Unhold</span>
              </button>
              <ng-template #freezeBatchButton>
                <button
                  class="p-button-outlined"
                  pButton
                  (click)="freezeBatch(item)"
                >
                  <span i18n>Hold Batch</span>
                </button>
              </ng-template>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </ng-container>
  <ng-container>
    <p-card header="Merchants" i18n-header styleClass="merchant-card">
      <table
        class="input-table"
        *ngIf="product.invited_merchant.length > 0; else noMerchants"
      >
        <thead>
          <tr>
            <th i18n>Merchant Name</th>
            <th i18n>Price</th>
            <th i18n>Tax</th>
            <th i18n>Limit</th>
            <th i18n>Sold</th>
            <th i18n>Available</th>
            <th i18n>Enabled</th>
          </tr>
        </thead>
        <tbody>
          <ng-container
            *ngFor="let merchantInvitation of product.invited_merchant"
          >
            <tr>
              <td>
                <p>{{ merchantInvitation.merchant.name }}</p>
              </td>
              <td>{{ merchantInvitation.price | currency : userCurrency }}</td>
              <td>
                <p *ngIf="merchantInvitation?.tax_id?.name; else noTax">
                  {{
                    merchantInvitation.tax_id.name +
                      " (" +
                      merchantInvitation.tax_id.amount +
                      generatePerfix(merchantInvitation.tax_id.amount_type) +
                      ")"
                  }}
                </p>
                <ng-template #noTax>
                  <p i18n>No Tax</p>
                </ng-template>
              </td>
              <td>
                <ng-container *ngIf="merchantInvitation.unlimited; else limit">
                  <p i18n>Unlimited</p>
                </ng-container>
                <ng-template #limit>
                  <p>{{ merchantInvitation.limit }}</p>
                </ng-template>
              </td>
              <td>
                {{ merchantInvitation.pulled_serials_count }}
              </td>

              <td>
                <ng-container
                  *ngIf="merchantInvitation.unlimited; else remaining"
                >
                  <p i18n>Unlimited</p>
                </ng-container>
                <ng-template #remaining>
                  <p>
                    {{ merchantInvitation.remaining_qty }}
                  </p>
                </ng-template>
              </td>
              <td>
                <ng-container *ngIf="merchantInvitation.enabled; else disabled">
                  <p i18n>Yes</p>
                </ng-container>
                <ng-template #disabled>
                  <p i18n>No</p>
                </ng-template>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
      <ng-template #noMerchants>
        <tr>
          <td colspan="8">
            <p i18n class="no-merchants">
              There are no invited merchants for this product yet.
            </p>
          </td>
        </tr>
      </ng-template>
    </p-card>
  </ng-container>
  <upload-serials-dialog
    (callback)="loadInfo(product.id)"
    [(dialogVisible)]="dialogVisible"
    [productInfo]="{ id: product.id, SKU: product.SKU }"
  ></upload-serials-dialog>
</ng-container>
<p-dialog
  position="top"
  [(visible)]="showStockHistoryChart"
  [style]="{ width: 'min(50rem, 90%)' }"
>
  <div class="spinner-wrapper" *ngIf="!stockHistory">
    <p-progressSpinner></p-progressSpinner>
  </div>
  <p-chart
    *ngIf="stockHistory"
    type="line"
    [data]="chartData"
    [options]="chartOptions"
  ></p-chart>
</p-dialog>
